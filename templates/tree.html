{% extends "base.html" %}
{% block title %}Growth Tree - CIC{% endblock %}
{% block content %}
<section class="tree-page">
    <div class="tree-header">
        <div>
            <h1>Your Growth Tree</h1>
            <p>Your personalized roadmap to circular economy success.</p>
        </div>
        <div class="header-actions">
            <a class="btn btn-secondary" href="{{ url_for('quiz') }}">Retake Quiz</a>
            <a class="btn" href="{{ url_for('services') }}">Browse Services</a>
        </div>
    </div>

    <div class="card tree-card">
        <div class="row-between">
            <div class="tier-pill tier-{{ tier|lower }}">Tier: {{ tier }}</div>
            <div class="meter-wrap small-meter">
                <div class="meter" style="--progress: {{ progress }}%;"><span>{{ progress }}%</span></div>
            </div>
        </div>

        {% if celebration %}
        <div class="celebration">ðŸŽ‰ {{ celebration }}</div>
        {% endif %}

        <div class="tree-layout">
            <div id="plotly-tree" class="plotly-tree" aria-label="Growth tree chart"></div>

        </div>

        <div class="year-sections">
            {% for year, items in [("Year 1", tree.year1), ("Year 2", tree.year2), ("Year 3", tree.year3)] %}
            <article class="year-section">
                <h3>{{ year }}</h3>
                <ul>
                    {% if items %}
                        {% for service_name in items %}
                        {% set detail = services_map.get(service_name, {}) %}
                        <li class="service-item {% if service_name in purchased %}service-item-purchased{% endif %}">
                            <div class="service-item-head">
                                <strong>{{ service_name }}</strong>
                                {% if service_name in purchased %}
                                <span class="owned">Added</span>
                                {% endif %}
                            </div>
                            <p>{{ detail.description or 'Recommended service for your roadmap.' }}</p>
                            {% set matched_items = recommended_subservices.get(service_name, []) %}
                            {% if matched_items %}
                            <ul>
                                {% for recommendation in matched_items %}
                                <li class="muted">{{ recommendation }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                            {% if service_name not in purchased %}
                                {% if service_name in locked_services %}
                                <span class="muted">Unlocks at {{ service_tier_map.get(service_name, 'higher') }} tier</span>
                                <a class="btn btn-disabled" aria-disabled="true" href="#">Add service</a>
                                {% else %}
                                <a class="btn" href="{{ url_for('buy', service_name=service_name) }}">Add service</a>
                                {% endif %}
                            {% endif %}
                        </li>
                        {% endfor %}
                    {% else %}
                        <li class="muted">No recommendations yet.</li>
                    {% endif %}
                </ul>
            </article>
            {% endfor %}
        </div>
    </div>

    <div class="stats-grid">
        <div class="card stat-card"><p>Services Added</p><h2>{{ purchased_count }}</h2></div>
        <div class="card stat-card"><p>Unlocked Services</p><h2>{{ unlocked_count }}</h2></div>
        <div class="card stat-card"><p>Current Tier</p><h2>{{ tier }}</h2></div>
    </div>
</section>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script>
(function () {
  const purchased = {{ purchased|list|tojson }};
  const tree = {{ tree|tojson }};
  const yearNodes = [
    { key: 'year1', x: 0, y: 3, label: 'Year 1' },
    { key: 'year2', x: -1.2, y: 1.7, label: 'Year 2' },
    { key: 'year3', x: 1.2, y: 1.7, label: 'Year 3' }
  ];

  const linesX = [0, -1.2, null, 0, 1.2, null];
  const linesY = [3, 1.7, null, 3, 1.7, null];

  const servicePoints = [];
  yearNodes.forEach((yearNode) => {
    const items = tree[yearNode.key] || [];
    const count = Math.max(items.length, 1);
    items.forEach((name, idx) => {
      const spread = count === 1 ? 0 : ((idx / (count - 1)) - 0.5) * 1.4;
      servicePoints.push({
        name,
        year: yearNode.label,
        x: yearNode.x + spread,
        y: yearNode.y - 1.1,
        purchased: purchased.includes(name)
      });
      linesX.push(yearNode.x, yearNode.x + spread, null);
      linesY.push(yearNode.y, yearNode.y - 1.1, null);
    });
  });

  const traces = [
    {
      type: 'scatter',
      mode: 'lines',
      x: linesX,
      y: linesY,
      line: { color: '#8b5e3c', width: 3 },
      hoverinfo: 'skip',
      showlegend: false
    },
    {
      type: 'scatter',
      mode: 'markers+text',
      x: yearNodes.map(n => n.x),
      y: yearNodes.map(n => n.y),
      text: yearNodes.map(n => n.label),
      textposition: 'middle center',
      marker: { size: 56, color: '#1f6f5f', line: { color: '#12473d', width: 2 } },
      textfont: { color: '#ffffff', size: 13 },
      hoverinfo: 'skip',
      showlegend: false
    },
    {
      type: 'scatter',
      mode: 'markers+text',
      x: servicePoints.map(p => p.x),
      y: servicePoints.map(p => p.y),
      text: servicePoints.map(p => p.name),
      textposition: 'bottom center',
      marker: {
        size: servicePoints.map(p => p.purchased ? 24 : 14),
        color: servicePoints.map(p => p.purchased ? '#ffd400' : '#7fa89d'),
        line: {
          color: servicePoints.map(p => p.purchased ? '#c37d00' : '#0f3f35'),
          width: servicePoints.map(p => p.purchased ? 3 : 1)
        }
      },
      hovertemplate: '%{text}<extra></extra>',
      showlegend: false
    }
  ];

  Plotly.newPlot('plotly-tree', traces, {
    margin: { l: 10, r: 10, t: 10, b: 20 },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    xaxis: { visible: false },
    yaxis: { visible: false }
  }, {displayModeBar: false, responsive: true});
})();
</script>
{% endblock %}
