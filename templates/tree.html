{% extends "base.html" %}
{% block title %}Growth Tree - CIC{% endblock %} <!-- Set page title -->
{% block content %} <!-- Start main content -->
<section class="tree-page">
    <!-- Header section with title + navigation buttons -->
    <div class="tree-header">
        <div>
            <h1>Your Growth Tree</h1> <!-- Main page title -->
            <p>Your personalized roadmap to circular economy success.</p>
        </div>
        <!-- Action buttons -->
        <div class="header-actions">
            <a class="btn btn-secondary" href="{{ url_for('quiz') }}">Retake Quiz</a>
            <a class="btn" href="{{ url_for('services') }}">Browse Services</a>
        </div>
    </div>

    <!-- Main tree container -->
    <div class="card tree-card">
        <!-- Tier display + progress bar -->
        <div class="row-between">
            <div class="tier-pill">Tier: {{ tier }}</div>
            <!-- Progress meter -->
            <div class="meter-wrap small-meter">
                <div class="meter" style="--progress: {{ progress }}%;"><span>{{ progress }}%</span></div>
            </div>
        </div>

        <!-- Celebratory message if user advanced tiers -->
        {% if celebration %}
        <div class="celebration">ðŸŽ‰ {{ celebration }}</div>
        {% endif %}

        <!-- Placeholder for Plotly chart -->
        <div id="plotly-tree" class="plotly-tree" aria-label="Growth tree chart"></div>

        <!-- Year-by-year service breakdown -->
        <div class="year-sections">
            <!-- Loop through each year and its services -->
            {% for year, items in [("Year 1", tree.year1), ("Year 2", tree.year2), ("Year 3", tree.year3)] %}
            <article class="year-section">
                <h3>{{ year }}</h3> <!-- Year title -->
                <ul>
                    {% if items %}
                        <!-- Loop through services in that year -->
                        {% for service_name in items %}
                        {% set detail = services_map.get(service_name, {}) %} <!-- Get service details -->
                        <!-- Service item -->
                        <li class="service-item {% if service_name in purchased %}service-item-purchased{% endif %}">
                            <!-- Service name + purchase status -->
                            <div class="service-item-head">
                                <strong>{{ service_name }}</strong>
                                {% if service_name in purchased %}
                                <span class="owned">Purchased</span>
                                {% endif %}
                            </div>
                            <!-- Service description -->
                            <p>{{ detail.description or 'Recommended service for your roadmap.' }}</p>
                            <!-- Price if available -->
                            {% if detail.price %}<p><strong>${{ detail.price }}</strong></p>{% endif %}
                            <!-- Buy button if not already purchased -->
                            {% if service_name not in purchased %}
                            <a class="btn" href="{{ url_for('buy', service_name=service_name) }}">Buy service</a>
                            {% endif %}
                        </li>
                        {% endfor %}
                    {% else %}
                        <!-- If no services recommended -->
                        <li class="muted">No recommendations yet.</li>
                    {% endif %}
                </ul>
            </article>
            {% endfor %}
        </div>
    </div>

    <!-- Summary stats section -->
    <div class="stats-grid">
        <div class="card stat-card"><p>Services Purchased</p><h2>{{ purchased_count }}</h2></div> <!-- Number of services bought -->
        <div class="card stat-card"><p>Total Investment</p><h2>${{ total_spent }}</h2></div> <!-- Total money spent -->
        <div class="card stat-card"><p>Current Discount</p><h2>{{ discount }}%</h2></div> <!-- Discount based on tier -->
    </div>
</section>

<!-- Load Plotly library for chart rendering -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script>
(function () {
    // Get purchased services and tree data from Flask (converted to JS)
  const purchased = {{ purchased|list|tojson }};
  const tree = {{ tree|tojson }};
    // Define positions for year nodes in the tree
  const yearNodes = [
    { key: 'year1', x: 0, y: 3, label: 'Year 1' },
    { key: 'year2', x: -1.2, y: 1.7, label: 'Year 2' },
    { key: 'year3', x: 1.2, y: 1.7, label: 'Year 3' }
  ];

    // Initial lines connecting the root to year nodes
  const linesX = [0, -1.2, null, 0, 1.2, null];
  const linesY = [3, 1.7, null, 3, 1.7, null];

  const servicePoints = [];
    // Loop through each year and place service nodes visually
  yearNodes.forEach((yearNode) => {
    const items = tree[yearNode.key] || [];
    const count = Math.max(items.length, 1);
    items.forEach((name, idx) => {
      const spread = count === 1 ? 0 : ((idx / (count - 1)) - 0.5) * 1.4;
      servicePoints.push({
        name,
        year: yearNode.label,
        x: yearNode.x + spread,
        y: yearNode.y - 1.1,
        purchased: purchased.includes(name)
      });
        // Draw line from year node to service node
      linesX.push(yearNode.x, yearNode.x + spread, null);
      linesY.push(yearNode.y, yearNode.y - 1.1, null);
    });
  });

    // Define chart layers (lines, year nodes, service nodes)
  const traces = [
    {
      type: 'scatter',
      mode: 'lines',
      x: linesX,
      y: linesY,
      line: { color: '#8b5e3c', width: 3 },
      hoverinfo: 'skip',
      showlegend: false
    },
    {
      type: 'scatter',
      mode: 'markers+text',
      x: yearNodes.map(n => n.x),
      y: yearNodes.map(n => n.y),
      text: yearNodes.map(n => n.label),
      textposition: 'middle center',
      marker: { size: 56, color: '#1f6f5f', line: { color: '#12473d', width: 2 } },
      textfont: { color: '#ffffff', size: 13 },
      hoverinfo: 'skip',
      showlegend: false
    },
    {
      type: 'scatter',
      mode: 'markers+text',
      x: servicePoints.map(p => p.x),
      y: servicePoints.map(p => p.y),
      text: servicePoints.map(p => p.name),
      textposition: 'bottom center',
      marker: {
        size: 18,
        color: servicePoints.map(p => p.purchased ? '#22a06b' : '#8fc6b7'),
        line: { color: '#0f3f35', width: 1 }
      },
      hovertemplate: '%{text}<extra></extra>',
      showlegend: false
    }
  ];

    // Render the Plotly chart
  Plotly.newPlot('plotly-tree', traces, {
    margin: { l: 10, r: 10, t: 10, b: 20 },
    paper_bgcolor: 'rgba(0,0,0,0)', // Transparent background
    plot_bgcolor: 'rgba(0,0,0,0)',
    xaxis: { visible: false }, // Hide axes
    yaxis: { visible: false }
  }, {displayModeBar: false, responsive: true});
})();
</script>
{% endblock %}
