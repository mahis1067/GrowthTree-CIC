{% extends "base.html" %}
{% block title %}Growth Tree - CIC{% endblock %}
{% block content %}
<section class="tree-page">
    <div class="tree-header">
        <div>
            <h1>Your Growth Tree</h1>
            <p>Your personalized roadmap to circular economy success.</p>
        </div>
        <div class="header-actions">
            <a class="btn btn-secondary" href="{{ url_for('quiz') }}">Retake Quiz</a>
            <a class="btn" href="{{ url_for('services') }}">Browse Services</a>
        </div>
    </div>

    <div class="card tree-card">
        <div class="row-between">
            <div class="tier-pill tier-{{ tier|lower }}">Tier: {{ tier }}</div>
            <div class="meter-wrap small-meter">
                <div class="meter" style="--progress: {{ progress }}%;"><span>{{ progress }}%</span></div>
            </div>
        </div>

        {% if celebration %}
        <div class="celebration">ðŸŽ‰ {{ celebration }}</div>
        {% endif %}

        <p class="muted">{% if tier == "Bronze" %}You are in Bronze: focus on Information Services first while previewing higher-tier opportunities.{% elif tier == "Silver" %}You are in Silver: start with Information + Relationship services, and preview Influential services for your next step.{% else %}You are in Gold: you can use all service groups across the tree.{% endif %}</p>

        <div class="tree-layout">
            <div id="plotly-tree" class="plotly-tree" aria-label="Growth tree chart"></div>
            <aside id="node-hover-card" class="node-hover-card hidden" aria-live="polite"></aside>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card stat-card"><p>Services Added</p><h2>{{ purchased_count }}</h2></div>
        <div class="card stat-card"><p>Unlocked Services</p><h2>{{ unlocked_count }}</h2></div>
        <div class="card stat-card"><p>Current Tier</p><h2>{{ tier }}</h2></div>
    </div>
</section>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script>
(function () {
  const tree = {{ tree|tojson }};
  const yearNodes = [
    { key: 'year1', x: 0, y: 3, label: 'Year 1' },
    { key: 'year2', x: -1.2, y: 1.7, label: 'Year 2' },
    { key: 'year3', x: 1.2, y: 1.7, label: 'Year 3' }
  ];

  const linesX = [0, -1.2, null, 0, 1.2, null];
  const linesY = [3, 1.7, null, 3, 1.7, null];

  const servicePoints = [];
  yearNodes.forEach((yearNode) => {
    const items = tree[yearNode.key] || [];
    const count = Math.max(items.length, 1);
    items.forEach((entry, idx) => {
      const spread = count === 1 ? 0 : ((idx / (count - 1)) - 0.5) * 1.4;
      servicePoints.push({
        x: yearNode.x + spread,
        y: yearNode.y - 1.1,
        subservice: entry.subservice,
        service: entry.service,
        group: entry.group,
        required_tier: entry.required_tier,
        is_locked: entry.is_locked,
        is_added: entry.is_added,
        use_url: entry.use_url,
      });
      linesX.push(yearNode.x, yearNode.x + spread, null);
      linesY.push(yearNode.y, yearNode.y - 1.1, null);
    });
  });

  const traces = [
    {
      type: 'scatter',
      mode: 'lines',
      x: linesX,
      y: linesY,
      line: { color: '#8b5e3c', width: 3 },
      hoverinfo: 'skip',
      showlegend: false
    },
    {
      type: 'scatter',
      mode: 'markers+text',
      x: yearNodes.map(n => n.x),
      y: yearNodes.map(n => n.y),
      text: yearNodes.map(n => n.label),
      textposition: 'middle center',
      marker: { size: 56, color: '#1f6f5f', line: { color: '#12473d', width: 2 } },
      textfont: { color: '#ffffff', size: 13 },
      hoverinfo: 'skip',
      showlegend: false
    },
    {
      type: 'scatter',
      mode: 'markers',
      x: servicePoints.map(p => p.x),
      y: servicePoints.map(p => p.y),
      marker: {
        size: servicePoints.map(p => p.is_added ? 24 : 16),
        color: servicePoints.map(p => p.is_locked ? '#b9c9c4' : (p.is_added ? '#ffd400' : '#7fa89d')),
        line: { color: '#0f3f35', width: 1.5 }
      },
      customdata: servicePoints,
      hovertemplate: '<extra></extra>',
      showlegend: false
    }
  ];

  Plotly.newPlot('plotly-tree', traces, {
    margin: { l: 10, r: 10, t: 10, b: 20 },
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)',
    xaxis: { visible: false },
    yaxis: { visible: false },
    annotations: [
      {
        x: -0.7,
        y: 1.9,
        text: 'Start with these Year 1 services',
        showarrow: true,
        arrowhead: 2,
        arrowsize: 1,
        arrowwidth: 2,
        arrowcolor: '#f4a331',
        ax: 90,
        ay: -45,
        font: { color: '#8a5b0b', size: 12 },
        bgcolor: 'rgba(255,255,255,0.9)',
        bordercolor: '#f4a331',
        borderwidth: 1
      }
    ]
  }, {displayModeBar: false, responsive: true});

  const plot = document.getElementById('plotly-tree');
  const card = document.getElementById('node-hover-card');

  function showCard(point) {
    const data = point.customdata || (point.data.customdata && point.data.customdata[point.pointIndex]);
    if (!data) {
      card.classList.add('hidden');
      return;
    }
    const lockNote = data.is_locked
      ? `<p class="muted">Unlocks at ${data.required_tier} tier.</p>`
      : `<p class="muted">Available in your current tier.</p>`;

    card.innerHTML = `
      <h4>${data.subservice}</h4>
      <p><strong>Service:</strong> ${data.service}</p>
      <p><strong>Group:</strong> ${data.group}</p>
      ${lockNote}
    `;
    card.classList.remove('hidden');
  }

  function handlePointEvent(eventData) {
    const point = eventData.points && eventData.points[0];
    if (!point || point.curveNumber !== 2) {
      card.classList.add('hidden');
      return;
    }
    showCard(point);
  }

  plot.on('plotly_hover', handlePointEvent);
  plot.on('plotly_click', handlePointEvent);
  plot.on('plotly_unhover', () => {
    card.classList.add('hidden');
  });
})();
</script>
{% endblock %}
